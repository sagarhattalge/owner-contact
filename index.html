function doGet(e) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheets()[0];

  const timestamp   = new Date();

  // From browser (existing fields)
  const url         = e.parameter.url || "";
  const referrer    = e.parameter.ref || "";
  const ua          = e.parameter.ua || "";
  const deviceType  = e.parameter.deviceType || "";
  const os          = e.parameter.os || "";
  const browser     = e.parameter.browser || "";
  const model       = e.parameter.model || "";
  const screen      = e.parameter.screen || "";
  const pixelRatio  = e.parameter.pixelRatio || "";
  const orient      = e.parameter.orient || "";
  const language    = e.parameter.language || "";
  const timezone    = e.parameter.timezone || "";

  // Raw ISP / org / ASN from browser (Geo/IP API)
  const rawIsp      = e.parameter.isp || "";
  const rawOrg      = e.parameter.org || "";
  const rawAsn      = e.parameter.asn || "";

  // From IP geolocation API (sent by browser)
  const ip          = e.parameter.ip || "";
  const city        = e.parameter.city || "";
  const region      = e.parameter.region || "";
  const country     = e.parameter.country || "";
  const countryCode = e.parameter.countryCode || "";
  const postal      = e.parameter.postal || "";
  const latitude    = e.parameter.latitude || "";
  const longitude   = e.parameter.longitude || "";

  // ---- Clean ISP / ASN ----
  var ispClean = rawIsp;
  var orgClean = rawOrg || rawIsp;  // if org missing, fall back to ISP
  var asnClean = rawAsn;

  // Common pattern: "AS45271 Vodafone Idea Ltd"
  if (!asnClean && rawIsp && rawIsp.toUpperCase().startsWith("AS")) {
    var firstSpace = rawIsp.indexOf(" ");
    if (firstSpace > 2) {
      asnClean = rawIsp.substring(0, firstSpace).trim();         // "AS45271"
      ispClean = rawIsp.substring(firstSpace + 1).trim();        // "Vodafone Idea Ltd"
      if (!rawOrg) {
        orgClean = ispClean;
      }
    }
  }

  // If ASN still empty but rawOrg looks like "ASxxxx Something"
  if (!asnClean && rawOrg && rawOrg.toUpperCase().startsWith("AS")) {
    var firstSpaceOrg = rawOrg.indexOf(" ");
    if (firstSpaceOrg > 2) {
      asnClean = rawOrg.substring(0, firstSpaceOrg).trim();
      if (!ispClean) {
        ispClean = rawOrg.substring(firstSpaceOrg + 1).trim();
      }
      if (!orgClean) {
        orgClean = ispClean;
      }
    }
  }

  // Final safety defaults
  if (!orgClean) orgClean = ispClean;
  if (!ispClean && orgClean) ispClean = orgClean;

  sheet.appendRow([
    timestamp,      // A: Timestamp
    url,            // B: URL
    referrer,       // C: Referrer
    ua,             // D: UserAgent
    deviceType,     // E: DeviceType
    os,             // F: OS
    browser,        // G: Browser
    model,          // H: Model
    screen,         // I: Screen
    pixelRatio,     // J: PixelRatio
    orient,         // K: Orientation
    language,       // L: Language
    timezone,       // M: Timezone
    ip,             // N: IP
    city,           // O: City
    region,         // P: Region
    country,        // Q: Country
    countryCode,    // R: CountryCode
    postal,         // S: Postal (approx PIN)
    latitude,       // T: Latitude (IP-based)
    longitude,      // U: Longitude (IP-based)
    ispClean,       // V: ISP
    orgClean,       // W: Org
    asnClean        // X: ASN
  ]);

  return ContentService
    .createTextOutput("OK")
    .setMimeType(ContentService.MimeType.TEXT);
}
