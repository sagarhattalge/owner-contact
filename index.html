<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Contact Owner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f3f4f6;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .card {
      background: #ffffff;
      padding: 24px 20px 28px;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
      max-width: 380px;
      width: 100%;
      text-align: center;
    }
    h1 {
      font-size: 22px;
      margin: 0 0 8px;
    }
    p {
      font-size: 14px;
      color: #4b5563;
      margin: 0 0 20px;
    }
    .btn {
      display: block;
      width: 100%;
      padding: 12px 16px;
      margin: 8px 0;
      border-radius: 999px;
      border: none;
      font-size: 16px;
      cursor: pointer;
      text-decoration: none;
      text-align: center;
      font-weight: 600;
    }
    .btn-call {
      background: #16a34a;
      color: #ffffff;
    }
    .btn-whatsapp {
      background: #22c55e;
      color: #ffffff;
    }
    .btn-gps {
      background: #3b82f6; /* blue */
      color: #ffffff;
    }
    .note {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 14px;
    }
    .note-geo {
      font-size: 11px;
      color: #6b7280;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>Contact Owner</h1>
    <p>Use one of the options below to reach the vehicle owner.</p>

    <!-- Call button -->
    <a class="btn btn-call" href="tel:+918805219473">
      Call Owner
    </a>

    <!-- WhatsApp button -->
    <a class="btn btn-whatsapp"
       href="https://wa.me/918805219473?text=Hello,%20I%20am%20contacting%20you%20regarding%20your%20car.">
      WhatsApp Owner
    </a>

    <!-- Share car location button (GPS) -->
    <button class="btn btn-gps" onclick="shareCarLocation()">
      üöó Share this car's location
    </button>

    <div class="note">
      For parking / emergency communication only.
    </div>
    <div id="geo-note" class="note-geo">
      Detecting approximate location‚Ä¶
    </div>
  </div>

  <!-- Logging + IP geolocation (ipapi.co + GeoJS fallback) + GPS button -->
  <script>
  (function() {

    // üî¥ IMPORTANT: paste your Apps Script Web App URL here:
    var LOG_URL = "https://script.google.com/macros/s/AKfycbxi3q5Y4xPRpL7E-ygPEEEDJCuRSOsIhelzh5hI9EGEkiX2YmxkJyLrBFo9Mp1qYTiTIw/exec";

    var geoNoteEl = document.getElementById("geo-note");

    function getDeviceType() {
      if (/mobile/i.test(navigator.userAgent)) return "Mobile";
      if (/tablet/i.test(navigator.userAgent)) return "Tablet";
      return "Desktop";
    }

    function getOS() {
      var ua = navigator.userAgent;
      if (/android/i.test(ua)) return "Android";
      if (/iphone|ipad|ipod/i.test(ua)) return "iOS";
      if (/windows/i.test(ua)) return "Windows";
      if (/macintosh/i.test(ua)) return "MacOS";
      return "Other";
    }

    function getBrowser() {
      var ua = navigator.userAgent;
      if (/edg/i.test(ua)) return "Edge";
      if (/chrome/i.test(ua)) return "Chrome";
      if (/safari/i.test(ua) && !/chrome/i.test(ua)) return "Safari";
      if (/firefox/i.test(ua)) return "Firefox";
      return "Other";
    }

    function extractModel() {
      var ua = navigator.userAgent;

      // Android example: "; SM-M325F Build/"
      var match = ua.match(/;\s?([A-Z0-9\-]+)\s?Build/i);
      if (match) return match[1];

      if (/iPhone/i.test(ua)) return "iPhone";
      if (/iPad/i.test(ua)) return "iPad";

      return "Unknown";
    }

    function sendLog(extra) {
      extra = extra || {};

      var params = {
        url:        window.location.href,
        ref:        document.referrer || "",
        ua:         navigator.userAgent || "",
        deviceType: getDeviceType(),
        os:         getOS(),
        browser:    getBrowser(),
        model:      extractModel(),
        screen:     window.screen.width + "x" + window.screen.height,
        pixelRatio: String(window.devicePixelRatio || 1),
        orient:     (screen.orientation && screen.orientation.type) ? screen.orientation.type : "unknown",
        language:   navigator.language || "",
        timezone:   (Intl.DateTimeFormat().resolvedOptions().timeZone || ""),

        // IP/location fields coming from API
        ip:          extra.ip          || "",
        city:        extra.city        || "",
        region:      extra.region      || "",
        country:     extra.country     || "",
        countryCode: extra.countryCode || "",
        postal:      extra.postal      || "",
        latitude:    extra.latitude    || "",
        longitude:   extra.longitude   || "",
        isp:         extra.isp         || "",
        org:         extra.org         || "",
        asn:         extra.asn         || "",

        // GPS fields (if provided)
        gps_lat:     extra.gps_lat     || "",
        gps_lng:     extra.gps_lng     || ""
      };

      var qs = Object.keys(params)
        .map(function(key) {
          return key + "=" + encodeURIComponent(params[key]);
        })
        .join("&");

      try {
        var img = new Image();
        img.src = LOG_URL + "?" + qs;
      } catch (e) {
        // ignore
      }
    }

    function updateGeoNote(extra, from) {
      if (!geoNoteEl) return;
      if (!extra) {
        geoNoteEl.textContent = "Location info not available.";
        return;
      }
      var locParts = [];
      if (extra.city)   locParts.push(extra.city);
      if (extra.region) locParts.push(extra.region);
      if (extra.country) locParts.push(extra.country);
      if (extra.postal) locParts.push("PIN " + extra.postal);

      if (locParts.length) {
        geoNoteEl.textContent =
          "Approximate location (" + from + "): " + locParts.join(", ");
      } else {
        geoNoteEl.textContent = "Approximate location detected (" + from + ").";
      }
    }

    function fallbackGeoJS() {
      // üåç GeoJS fallback (no postal/pincode)
      fetch("https://get.geojs.io/v1/ip/geo.json")
        .then(function(res) { return res.json(); })
        .then(function(data) {
          var extra = {
            ip:          data.ip || "",
            city:        data.city || "",
            region:      data.region || "",
            country:     data.country || "",
            countryCode: data.country_code || "",
            postal:      "", // GeoJS does not provide postal
            latitude:    data.latitude || "",
            longitude:   data.longitude || "",
            isp:         data.organization || "",
            org:         data.organization || "",
            asn:         "" // not provided directly
          };

          updateGeoNote(extra, "GeoJS");
          sendLog(extra);
        })
        .catch(function(err) {
          updateGeoNote(null);
          sendLog({});
        });
    }

    function fetchIpAndLog() {
      // First try ipapi.co (gives postal/pincode if available)
      fetch("https://ipapi.co/json/")
        .then(function(res) { return res.json(); })
        .then(function(data) {
          if (data && !data.error) {
            var extra = {
              ip:          data.ip || "",
              city:        data.city || "",
              region:      data.region || "",
              country:     data.country_name || "",
              countryCode: data.country || "",
              postal:      data.postal || "",
              latitude:    (data.latitude != null ? String(data.latitude) : ""),
              longitude:   (data.longitude != null ? String(data.longitude) : ""),
              isp:         data.org || "",
              org:         data.org || "",
              asn:         data.asn || ""
            };

            updateGeoNote(extra, "ipapi");
            sendLog(extra);
          } else {
            // If ipapi returns error field, use GeoJS fallback
            fallbackGeoJS();
          }
        })
        .catch(function(err) {
          // If ipapi fails (blocked / rate limited), fallback to GeoJS
          fallbackGeoJS();
        });
    }

    // Start IP-based logging on page load
    try {
      fetchIpAndLog();
    } catch (e) {
      updateGeoNote(null);
      sendLog({});
    }

    // Expose GPS function globally for button onclick
    window.shareCarLocation = function() {
      if (!navigator.geolocation) {
        alert("Geolocation is not supported on this device.");
        return;
      }

      navigator.geolocation.getCurrentPosition(
        function(position) {
          var lat = position.coords.latitude;
          var lng = position.coords.longitude;

          // Log a second row with GPS data included
          sendLog({
            gps_lat: String(lat),
            gps_lng: String(lng)
          });

          alert("Car location shared successfully!");
        },
        function(error) {
          alert("Unable to access GPS: " + error.message);
        }
      );
    };

  })();
  </script>
</body>
</html>
